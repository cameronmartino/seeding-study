---
title: "Beta not related"
author: "Jincheng Wang"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE, warning = FALSE, message = FALSE)
# Loading library here
library(tidyverse)
library(extrafont)
# library(biomformat)
library(qiime2R)
library(phyloseq)

sessionInfo()
np = switch(Sys.info()[['sysname']], Windows = 1, Darwin = 4)
```

```{r, eval=FALSE}
# import metadata
mf <- read.delim("../data/processed-data/Metadata_Baby_Seeding_all_samples_final.txt", header = T, sep = "\t", na.strings = c("", "NA"), stringsAsFactors = F)

mf_t <- mf %>% filter(date_sampling_category_days_continuous<=90, date_sampling_category_days_continuous>=30, mom_baby=="Baby", country=="USA", project_name!="ECAM", birth_mode_ms != "CSseed", body_site_type=="Fecal")
write.table(mf_t, file = "tmp_beta_not_related.txt", quote = F, sep = "\t", row.names = F)
```
### Filter feature table in qiime
```{qiime}
qiime feature-table filter-samples --i-table ../data/processed-data/table.qza --m-metadata-file tmp_beta_not_related.txt --o-filtered-table table_beta_not_related.qza
```
### Import feature table with only control samples
```{r, eval=FALSE}
# filtered feature table contain only control samples
ft_qza <- read_qza("table_beta_not_related.qza")

## feature table in dataframe
ft <- ft_qza$data %>% as.data.frame() %>% rownames_to_column(var = "otu_id") %>% filter(rowSums(.[,-1])!=0)

# actual sequencing count
seqcount <- ft[, -1] %>% colSums()
## Metadata only with samples that have sequences

mt_ft <- mf_t %>% filter(sample_name %in% colnames(ft)) 
```

3. Merge all things into a phyloseq object (no need to run)
```{r, eval=FALSE}
otu <- otu_table(ft %>% column_to_rownames(var = "otu_id"), taxa_are_rows = T)

tree <- read_qza("../data/processed-data/tree.qza")
tree <- ape::keep.tip(tree$data, rownames(otu_table(otu)))

# this object have the otu table, metadata and the phylogenetic tree
phylo <- merge_phyloseq(otu, sample_data(mt_ft %>% column_to_rownames(var = "sample_name")), tree)
phylo <- filter_taxa(phylo, function(x) {sum(x)>0}, prune = T)
```
```{r}
phylo_6k <- rarefy_even_depth(phylo, sample.size = 6000, rngseed = 20, replace = F, trimOTUs = T)
```


### Beta diversity comparison
```{r}

beta_dist <- lapply(c("bray", "unifrac", "wunifrac"), function(x){distance(phylo_6k, method = x)})
names(beta_dist) = c("bray", "unifrac", "wunifrac")

beta_ord <- 
dist_jac <- distance(phylo_filtered, method = "jaccard", binary = T)
ord_jac <- ordinate(phylo_filtered, "PCoA", distance = dist_jac)

p <- plot_ordination(phylo_filtered, ord_jac)
col <- c('#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffff33','#a65628','#f781bf')
names(col) <- c("Feces", "Field_BL", "Lib_BL", "Forearm", "Mouth", "Right_Areola", "Nose", "Vagina")

p1 <- ggplot(p$data, aes(Axis.1, Axis.2, color = body_site_corrected, shape = mom_baby)) +
    geom_point() +
    scale_color_manual(values = col) +
    stat_ellipse(aes(group = mom_baby, linetype = mom_baby)) +
    scale_shape_manual(values = c(1, 17, 16)) + 
    theme_bw(base_size = 10) + theme(aspect.ratio = 1) +
    labs(x = paste0("Axis.1 [", round(ord_jac$values$Relative_eig[1]*100,1), "%]"), y =paste0("Axis.2 [", round(ord_jac$values$Relative_eig[2]*100,1), "%]"))

p2 <- ggplot(p$data, aes(Axis.1, Axis.2, shape = mom_baby)) +
    geom_point(aes(fill = seqcount), size = 1, color = "grey") +
    scale_fill_gradientn(colours = c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'), values = scales::rescale(c(0, 5000)), limits = c(0, 7000), na.value = '#253494', breaks = c(0, 2000, 5000)) +
    stat_ellipse(aes(group = mom_baby, linetype = mom_baby)) +
    scale_shape_manual(values = c(21, 24, 22)) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1) +
    labs(x = paste0("Axis.1 [", round(ord_jac$values$Relative_eig[1]*100,1), "%]"), y =paste0("Axis.2 [", round(ord_jac$values$Relative_eig[2]*100,1), "%]"))
p2

p1 + p2 + plot_layout(guides = "collect") & theme(legend.position = 'bottom', legend.direction = "vertical")
ggsave(p2, filename = "../results/controlvsamples_2.pdf", width = 7, useDingbats = F)
```
Similarity/distance comparison
```{r}
mt_filterd_phylo <- sample_data(phylo_filtered) %>% as.matrix %>% as.data.frame() %>% rownames_to_column(var = "sample_name")

# dist of mother samples by site.
mt_filtered_phylo_mm <- mt_filterd_phylo %>% filter(mom_baby=="Mom")
dist_mm_by_site <- split(mt_filtered_phylo_mm, mt_filtered_phylo_mm$body_site_corrected) %>% lapply(., function(x){subset_dm_by_names(dist_jac, x$sample_name) %>% as.numeric})

dist_tbl <- lapply(seq_along(dist_mm_by_site), function(x){data.frame(distance = dist_mm_by_site[[x]], cat1 = names(dist_mm_by_site)[[x]], cat2 = "SampleRef")}) %>% do.call("rbind", .)


# dist of blanks within group 
mt_filtered_phylo_bl <- mt_filterd_phylo %>% filter(mom_baby=="Blanks")
dist_bl_by_site <- split(mt_filtered_phylo_bl, mt_filtered_phylo_bl$body_site_corrected) %>% lapply(., function(x){subset_dm_by_names(dist_jac, x$sample_name) %>% as.numeric})

dist_tbl <- rbind(dist_tbl, lapply(seq_along(dist_bl_by_site), function(x){data.frame(distance = dist_bl_by_site[[x]], cat1 = names(dist_bl_by_site)[[x]], cat2 = "Blanks")}) %>% do.call("rbind", .))


# dist of blanks vs samples
dist_blvSS <- (dist_jac %>% as.matrix())[mt_filtered_phylo_bl$sample_name, mt_filterd_phylo %>% filter(mom_baby!="Blanks") %>% pull(sample_name)] %>% as.data.frame() %>% rownames_to_column(var = "sample_name_bl") %>% pivot_longer(-1, names_to = "sample_name_ss", values_to = "distance") %>% arrange(sample_name_bl, distance) 

## select the 3 shortest distance for each sample
dist_blvSS_low <- dist_blvSS %>% group_by(sample_name_bl) %>% filter(distance<=distance[3]) %>% merge(., mt_filtered_phylo_bl, by.x = 1, by.y = 1)
dist_tbl_sub <- dist_blvSS_low %>% select(sample_name_bl, distance, body_site_corrected, seqcount, sample_name_ss) %>% merge(., mt_filterd_phylo %>% select(sample_name, mom_baby, body_site_corrected), by.x = "sample_name_ss", by.y = "sample_name", all.x = T) %>% rename(cat1 = body_site_corrected.x, ss_mom_baby = mom_baby, ss_body_site = body_site_corrected.y) %>% mutate(cat2 = "BlanksToSamples", seqcount = as.numeric(seqcount))
dist_tbl_sub2 <- dist_blvSS_low %>% select(sample_name_bl, distance, body_site_corrected, seqcount, sample_name_ss) %>% merge(., mt_filterd_phylo %>% select(sample_name, mom_baby, body_site_corrected), by.x = "sample_name_ss", by.y = "sample_name", all.x = T) %>% rename(cat1 = body_site_corrected.x, ss_mom_baby = mom_baby, ss_body_site = body_site_corrected.y) %>% mutate(cat2 = "BlanksToSamples", seqcount = as.numeric(seqcount)) %>% group_by(cat2, cat1, seqcount, sample_name_bl) %>% summarise(distance = mean(distance)) %>% ungroup()

#dist_tbl <- plyr::rbind.fill(dist_tbl, dist_tbl_sub %>% select(-c(1, 2))) %>% mutate(seqcount = as.numeric(seqcount))

p1 <- ggplot(dist_tbl, aes(cat2, distance)) +
    geom_point(position = position_jitter(), color = "grey50") +
    geom_boxplot(color = "blue", fill = NA, outlier.shape = NA) +
    theme_bw(base_size = 10) +theme(aspect.ratio = 1) + 
    labs(x = "")

p2 <- ggplot(dist_tbl_sub2, aes(seqcount, distance)) +
    geom_point(aes(fill= seqcount), color = "grey", shape = 21) +
    scale_fill_gradientn(colours = c('#ffffcc','#a1dab4','#41b6c4','#2c7fb8','#253494'), values = scales::rescale(c(0, 5000)), limits = c(0, 7000), na.value = '#253494', breaks = c(0, 2000, 5000)) +
    scale_x_continuous(trans = "log10") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.6)

p1 + p2 & coord_cartesian(ylim = c(0.6, 1))
ggsave(filename = "../results/controlvsamples_3.pdf", width = 9, useDingbats = F)

```

### ASV prevalence in control and baby samples
1. Controls
```{r}
# phylo_all
## creating a dictionary to map OTU id with an arbitrary index
dict_otu = tax_table(phylo_all) %>% as.matrix() %>% as.data.frame() %>% rownames_to_column(var = "otu_id")  %>% mutate(otu_ind = paste0("ASV", seq(n())))

## asv prevalence in controls
ft_bl_l = ft_all[, c("otu_id", mt_ft_bl$sample_name)] %>%  pivot_longer(names_to = "sample_name", values_to = "count", cols = -1) %>% filter(count>0) %>% group_by(sample_name) %>% mutate(rela = count/sum(count)) %>% left_join(., mt_ft_bl, by = "sample_name")

asv_prev_bl_sum = ft_bl_l %>% group_by(otu_id) %>% summarise(N = length(unique(sample_name)), Cat = ifelse(length(unique(Cat_control))>1, "Both", paste0(unique(Cat_control), "-Only")), Avg_ct = mean(count), Med_ct = median(count), Avg_rela = mean(rela), Med_rela = median(rela)) %>% left_join(., dict_otu, by = "otu_id")
```
162 control samples, 1804 ASVs identified in total.
```{r}
ggplot(asv_prev_bl_sum, aes(x = N, y = ..count..)) +
    geom_bar(aes(fill = Cat)) +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1.5) +
    scale_x_continuous(breaks = seq(0, 90, 10)) +
    labs(x = "Prevalance", y = "N of ASVs", title = "Histogram of ASV prevalence in blank samples", fill = "Type of blanks")

ggplot(asv_prev_bl_sum, aes(x = N, y = Med_ct)) + 
    geom_point() +
    scale_y_log10() + 
    theme_bw(base_size = 10) + theme(aspect.ratio = 0.8) +
    labs(x = "Prevalance", y = "Median count of a ASV across blank samples in which it appeared", title = "Median abundance of ASVs by their prevalance")
```

<!-- 2. -->
<!-- ```{r} -->
<!-- ft_bbbl_l = ft_all[, c("otu_id", mt_ft_bl$sample_name, mt_ft_bb$sample_name)] %>% filter(rowSums(.[, -1])>0) %>% pivot_longer(names_to = "sample_name", values_to = "count", cols = -1) %>% filter(count>0) %>% group_by(sample_name) %>% mutate(rela = count/sum(count)) -->

<!-- mt_bbbl = rbind(mt_ft_bl, mt_ft_bb) -->

<!-- asv_bbbl_sum <- left_join(ft_bbbl_l, mt_bbbl, by = "sample_name") %>% mutate(Group1 = ifelse(is.na(body_site_type), "Control", body_site_type)) %>% group_by(otu_id, Group1) %>% summarise(N = length(unique(sample_name)), Avg_ct = mean(count), Med_ct = median(count), Avg_rela = mean(rela), Med_rela = median(rela), Prev = case_when(Group1=="Oral" ~ N/926, Group1=="Fecal" ~ N/1391, Group1=="Skin"~N/894, T~N/162)) %>% ungroup %>% complete(otu_id, Group1, fill = list(Prev = 0)) -->

<!-- asv_bbbl_sum$otu_id <- factor(asv_bbbl_sum$otu_id, levels = asv_bbbl_sum[asv_bbbl_sum$Group1=="Fecal", ] %>% arrange(Prev) %>% distinct(otu_id) %>% pull(otu_id)) -->

<!-- ggplot(asv_bbbl_sum, aes(x = otu_id, y = Prev, color = Group1)) + -->
<!--     geom_point(size = 0.5) + -->
<!--     theme_bw() + theme(axis.text.x = element_blank()) + -->
<!--     scale_y_continuous(trans = "log10") -->
<!-- ``` -->

2. ASV appeared in control samples prevalence in baby samples

```{r}
mt_ft_bb <- mt_all %>% filter(mom_baby=="Baby")
## asv prevalence in controls
ft_bb_l = ft_all[, c("otu_id", mt_ft_bb$sample_name)] %>% filter(rowSums(.[, -1])>0) %>% pivot_longer(names_to = "sample_name", values_to = "count", cols = -1) %>% filter(count>0) %>% group_by(sample_name) %>% mutate(rela = count/sum(count)) %>% left_join(., mt_ft_bb, by = "sample_name")
# ft_bb_l$otu_id %>% unique %>% length

ft_bb_l_asv_in_bl <- ft_bb_l %>% filter(otu_id %in% ft_bl_l$otu_id)

asv_prev_bb_sum <- ft_bb_l_asv_in_bl %>% group_by(otu_id) %>% summarise(N = length(unique(sample_name)), Avg_ct = mean(count), Med_ct = median(count), Avg_rela = mean(rela), Med_rela = median(rela)) %>% left_join(., dict_otu, by = "otu_id")
```
3211 baby samples, 39817 ASV in total, share 1134 ASV with control samples

```{r}
# merge the baby asv table with control asv table together
asv_prev_sum <- right_join(asv_prev_bl_sum, asv_prev_bb_sum %>% select(-c(Domain: otu_ind)), by = "otu_id", suffix = c(".bl", ".bb")) %>% arrange(N.bl)
asv_prev_sum$otu_ind <- factor(asv_prev_sum$otu_ind, levels = asv_prev_sum$otu_ind)

p1 <- ggplot(asv_prev_sum, aes(x = otu_ind)) +
    geom_line(aes(y = N.bb, group = 1, color = "Baby Samples")) +
    geom_line(aes(y = N.bl*30, group = 1, color = "Blank Samples")) +
    scale_y_continuous(name = "Prevalence in baby samples", breaks = seq(0, 2500, 250), sec.axis = sec_axis(~./30, name = "Prevalence in blanks", breaks = seq(0, 80, 10))) +
    scale_color_manual(breaks = c("Baby Samples", "Blank Samples"), values = c("#377eb8", "#e41a1c")) +
    theme_bw(base_size = 10) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), aspect.ratio = 1, legend.position = c(0.01, 0.95), legend.justification = c(0, 1), plot.title = element_text(hjust = 0, size = 8)) +
    labs(x = "Individual ASV ordered by prevalance in blank samples", color = "", title = "A.Prevalences of common ASVs in baby samples (blue) and blanks (red)")

Hmisc::rcorr(asv_prev_sum$N.bl, asv_prev_sum$N.bb, type = "pearson")
Hmisc::rcorr(asv_prev_sum$N.bl, asv_prev_sum$N.bb, type = "spearman")


p2 <- ggplot(asv_prev_sum, aes(x = N.bl, y = N.bb)) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1, plot.title = element_text(hjust = 0, size = 8)) +
    scale_y_continuous(breaks = seq(0, 2500, 250)) + scale_x_continuous(breaks = seq(0, 80, 10)) +
    coord_cartesian(ylim = c(0, 2500)) +
    annotate(geom = "label", x = 0, y = 2400, label = "Pearson rho = 0.76; Spearman rho = 0.64", hjust = 0, size = 8/.pt) +
    labs(x = "Prevalence in blanks", y = "Prevalence in baby samples", title = "B. Correlation between prevalences in in baby samples and blanks")

p1 + p2

ggsave("../results/controlvsamples_4.pdf", width = 11, useDingbats = F)
```
1134 ASVs appeared in both types of samples.


3.3 ASV appeared in control samples prevlance in baby oral and skin samples
```{r}
mt_ft_bb_os <- mt_ft_bb %>% filter(body_site_type != "Fecal" )
## asv prevalence in controls
ft_bb_os_l = ft_bb_l %>% filter(sample_name %in% mt_ft_bb_os$sample_name)
# ft_bb_os_l$otu_id %>% unique %>% length

ft_bb_os_l_asv_in_bl <- ft_bb_os_l %>% filter(otu_id %in% ft_bl_l$otu_id)
# ft_bb_os_l_asv_in_bl$otu_id %>% unique %>% length

asv_prev_bb_os_sum <- ft_bb_os_l_asv_in_bl %>% group_by(otu_id) %>% summarise(N = length(unique(sample_name)), Avg_ct = mean(count), Med_ct = median(count), Avg_rela = mean(rela), Med_rela = median(rela)) %>% left_join(., dict_otu, by = "otu_id")
```
1820 baby samples, 31977 ASV in total, share 1088 ASV with control samples

```{r}
# merge the baby asv table with control asv table together
asv_prev_sum_2 <- right_join(asv_prev_bl_sum, asv_prev_bb_os_sum %>% select(-c(Domain: otu_ind)), by = "otu_id", suffix = c(".bl", ".bb")) %>% mutate(Pct.N.bl = N.bl/162, Pct.N.bb = N.bb/1820) %>% arrange(Pct.N.bb)
asv_prev_sum_2$otu_ind <- factor(asv_prev_sum_2$otu_ind, levels = asv_prev_sum_2$otu_ind)

p1 <- ggplot(asv_prev_sum_2, aes(x = otu_ind)) +
    geom_line(aes(y = N.bb, group = 1, color = "Baby Samples")) +
    geom_line(aes(y = N.bl*20, group = 1, color = "Blank Samples")) +
    scale_y_continuous(name = "Prevalence in baby samples", n.breaks = 8, sec.axis = sec_axis(~./20, name = "Prevalence in blanks", breaks = seq(0, 80, 10))) +
    scale_color_manual(breaks = c("Baby Samples", "Blank Samples"), values = c("#377eb8", "#e41a1c")) +
    theme_bw(base_size = 10) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), aspect.ratio = 1, legend.position = c(0.01, 0.95), legend.justification = c(0, 1), plot.title = element_text(hjust = 0, size = 8)) +
    labs(x = "Individual ASV ordered by prevalance in blank samples", color = "", title = "A.Prevalences of common ASVs in baby oral and skin samples (blue) and blanks (red)")
p1
Hmisc::rcorr(asv_prev_sum_2$N.bl, asv_prev_sum_2$N.bb, type = "pearson")
Hmisc::rcorr(asv_prev_sum_2$N.bl, asv_prev_sum_2$N.bb, type = "spearman")


p2 <- ggplot(asv_prev_sum_2, aes(x = N.bl, y = N.bb)) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1, plot.title = element_text(hjust = 0, size = 8)) +
    scale_y_continuous(breaks = seq(0, 2500, 250)) + scale_x_continuous(breaks = seq(0, 80, 10)) +
    coord_cartesian(ylim = c(0, 2500)) +
    annotate(geom = "label", x = 0, y = 2400, label = "Pearson rho = 0.72; Spearman rho = 0.63", hjust = 0, size = 8/.pt) +
    labs(x = "Prevalence in blanks", y = "Prevalence in baby samples", title = "B. Correlation between prevalences in in baby oral and skin samples and blanks")

p1 + p2

ggsave("../results/controlvsamples_5.pdf", width = 11, useDingbats = F)

ggplot(asv_prev_sum_2, aes(x = otu_ind)) +
    geom_point(aes(y = Pct.N.bb, color = "Baby Samples"), size = 0.5) +
    geom_point(aes(y = Pct.N.bl, color = "Blank Samples"), size = 0.5) +
    scale_y_continuous(n.breaks = 10) +
    scale_color_manual(breaks = c("Baby Samples", "Blank Samples"), values = c("#377eb8", "#e41a1c")) +
    theme_bw(base_size = 10) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), aspect.ratio = 1, legend.position = c(0.01, 0.95), legend.justification = c(0, 1), plot.title = element_text(hjust = 0, size = 8)) +
    labs(x = "Individual ASV ordered by prevalance in blank samples", y = "Prevalence of an ASV among blanks or baby samples", color = "", title = "Prevalences of common ASVs in baby oral and skin samples (blue) and blanks (red)")




ggsave("../results/controlvsamples_5-1.pdf", width = 5, useDingbats = F)

ggplot(asv_prev_sum_2, aes(x = otu_ind)) +
    geom_point(aes(y = Med_ct.bb, color = "Baby Samples"), size = 0.5) +
    geom_point(aes(y = Med_ct.bl, color = "Blank Samples"), size = 0.5) +
    scale_y_continuous(n.breaks = 10) +
    scale_color_manual(breaks = c("Baby Samples", "Blank Samples"), values = c("#377eb8", "#e41a1c")) +
    theme_bw(base_size = 10) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), aspect.ratio = 1, legend.position = c(0.01, 0.95), legend.justification = c(0, 1), plot.title = element_text(hjust = 0, size = 8)) +
    labs(x = "Individual ASV ordered by prevalance in blank samples", y = "Prevalence of an ASV among blanks or baby samples", color = "", title = "Prevalences of common ASVs in baby oral and skin samples (blue) and blanks (red)")

```
1088 ASVs appeared in both types of samples.


3.4 ASV appeared in control samples prevlance in baby fecal samples
```{r}
mt_ft_bb_f <- mt_ft_bb %>% filter(body_site_type == "Fecal" )
## asv prevalence in controls
ft_bb_f_l = ft_bb_l %>% filter(sample_name %in% mt_ft_bb_f$sample_name)
# ft_bb_f_l$otu_id %>% unique %>% length

ft_bb_f_l_asv_in_bl <- ft_bb_f_l %>% filter(otu_id %in% ft_bl_l$otu_id)
# ft_bb_f_l_asv_in_bl$otu_id %>% unique %>% length

asv_prev_bb_f_sum <- ft_bb_f_l_asv_in_bl %>% group_by(otu_id) %>% summarise(N = length(unique(sample_name)), Avg_ct = mean(count), Med_ct = median(count), Avg_rela = mean(rela), Med_rela = median(rela)) %>% left_join(., dict_otu, by = "otu_id")
```
1391 baby samples, 11441 ASV in total, share 810 ASV with control samples

```{r}
# merge the baby asv table with control asv table together
asv_prev_sum_3 <- right_join(asv_prev_bl_sum, asv_prev_bb_f_sum %>% select(-c(Domain: otu_ind)), by = "otu_id", suffix = c(".bl", ".bb")) %>% mutate(Pct.N.bl = N.bl/162, Pct.N.bb = N.bb/1391) %>% arrange(Pct.N.bb)
asv_prev_sum_3$otu_ind <- factor(asv_prev_sum_3$otu_ind, levels = asv_prev_sum_3$otu_ind)

p1 <- ggplot(asv_prev_sum_3, aes(x = otu_ind)) +
    geom_line(aes(y = N.bb, group = 1, color = "Baby Samples")) +
    geom_line(aes(y = N.bl*20, group = 1, color = "Blank Samples")) +
    scale_y_continuous(name = "Prevalence in baby samples", n.breaks = 8, sec.axis = sec_axis(~./20, name = "Prevalence in blanks")) +
    scale_color_manual(breaks = c("Baby Samples", "Blank Samples"), values = c("#377eb8", "#e41a1c")) +
    theme_bw(base_size = 10) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), aspect.ratio = 1, legend.position = c(0.01, 0.95), legend.justification = c(0, 1), plot.title = element_text(hjust = 0, size = 8)) +
    labs(x = "Individual ASV ordered by prevalance in blank samples", color = "", title = "A.Prevalences of common ASVs in baby fecal samples (blue) and blanks (red)")
p1

Hmisc::rcorr(asv_prev_sum_3$N.bl, asv_prev_sum_3$N.bb, type = "pearson")
Hmisc::rcorr(asv_prev_sum_3$N.bl, asv_prev_sum_3$N.bb, type = "spearman")


p2 <- ggplot(asv_prev_sum_3, aes(x = N.bl, y = N.bb)) +
    geom_point() +
    geom_smooth(method = "lm") +
    theme_bw(base_size = 10) + theme(aspect.ratio = 1, plot.title = element_text(hjust = 0, size = 8)) +
    scale_y_continuous(breaks = seq(0, 2500, 250)) + scale_x_continuous(breaks = seq(0, 80, 10)) +
    coord_cartesian(ylim = c(0, 2500)) +
    annotate(geom = "label", x = 0, y = 2400, label = "Pearson rho = 0.72; Spearman rho = 0.63", hjust = 0, size = 8/.pt) +
    labs(x = "Prevalence in blanks", y = "Prevalence in baby samples", title = "B. Correlation between prevalences in in baby fecal samples and blanks")

p1 + p2

ggsave("../results/controlvsamples_6.pdf", width = 11, useDingbats = F)

ggplot(asv_prev_sum_3, aes(x = otu_ind)) +
    geom_point(aes(y = Pct.N.bb, color = "Baby Samples"), size = 0.5) +
    geom_point(aes(y = Pct.N.bl, color = "Blank Samples"), size = 0.5) +
    scale_y_continuous(breaks = seq(0, 1, 0.1), limits = c(0, 1)) +
    scale_color_manual(breaks = c("Baby Samples", "Blank Samples"), values = c("#377eb8", "#e41a1c")) +
    theme_bw(base_size = 10) + theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), aspect.ratio = 1, legend.position = c(0.01, 0.95), legend.justification = c(0, 1), plot.title = element_text(hjust = 0, size = 8)) +
    labs(x = "Individual ASV ordered by prevalance in blank samples", y = "Prevalence of an ASV among blanks or baby samples", color = "", title = "Prevalences of common ASVs in baby fecal samples (blue) and blanks (red)")

ggsave("../results/controlvsamples_6-2.pdf", width = 5, useDingbats = F)
```
3.5 
```{r}

# filter appeared in more than 10% of each type, and had a med relative abundance in samples  >0.1%
asv_prev_sum_2_cand <- asv_prev_sum_2 %>% filter(N.bl>16, N.bb>182, Med_rela.bb>0.001) %>% select(-c(Domain:Species))

asv_prev_sum_3_cand <- asv_prev_sum_3 %>% filter(N.bl>16, N.bb>139, Med_rela.bb>0.001) %>% select(-c(Domain:Species))

colnames(asv_prev_sum_2_cand) <- c("otu_id", "N.bl", "Cat", "Avg_ct.bl", "Med_ct.bl", "Avg_rela.bl", "Med_rela.bl", "otu_ind", "N.bb1", "Avg_ct.bb1", "Med_ct.bb1", "Avg_rela.bb1", "Med_rela.bb1")
colnames(asv_prev_sum_3_cand) <- c("otu_id", "N.bl", "Cat", "Avg_ct.bl", "Med_ct.bl", "Avg_rela.bl", "Med_rela.bl", "otu_ind", "N.bb2", "Avg_ct.bb2", "Med_ct.bb2", "Avg_rela.bb2", "Med_rela.bb2")

asv_prev_sum_all <- full_join(asv_prev_sum_2_cand, asv_prev_sum_3_cand, by = c("otu_id", "N.bl", "Cat", "Avg_ct.bl", "Med_ct.bl", "Avg_rela.bl", "Med_rela.bl", "otu_ind")) %>% left_join(., dict_otu, by = c("otu_id", "otu_ind"))

write.table(asv_prev_sum_all, file = "../results/candidate_contamination.txt", sep = "\t", quote = F, row.names = F)

```

## functions
```{r}
subset_dm_by_names <- function(DM, Sname){
    # Extract the distance matrix using the sample names of a subset of the samples
    #
    # Args:
    #   DM: the distance matrix as a dist class
    #   Sname: a vector of the sample names
    #
    # Returns:
    #   The extracted distance matrix as a class dist object
    DM_mat <- DM %>% as.matrix
    DM_sname <- DM_mat %>% row.names()
    tmp <- match(Sname, DM_sname)
    Exist <- tmp[!is.na(tmp)]
    NoExist <- Sname[which(is.na(tmp))]
    print("Following samples do not exist in the distance matrix:")
    print(NoExist)
    DM <- DM_mat[Exist, Exist] %>% as.dist()
    return(DM)
}
```


## Recyled codes:
```{r}
# # taxonomy
# taxa_qza <- read_qza("../data/processed-data/taxonomy.qza")
# taxa_tbl <- taxa_qza$data %>% filter(Feature.ID %in% ft_bl$otu_id) %>% mutate(Taxon = gsub(pattern = "__", replacement = "_", Taxon)) %>% separate(Taxon, into = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species"), sep = "; ", remove = F)
# taxa_tbl$Domain[is.na(taxa_tbl$Domain)] <- "k_"
# taxa_tbl$Phylum[is.na(taxa_tbl$Phylum)] <- "p_"
# taxa_tbl$Class[is.na(taxa_tbl$Class)] <- "c_"
# taxa_tbl$Order[is.na(taxa_tbl$Order)] <- "o_"
# taxa_tbl$Family[is.na(taxa_tbl$Family)] <- "f_"
# taxa_tbl$Genus[is.na(taxa_tbl$Genus)] <- "g_"
# taxa_tbl$Species[is.na(taxa_tbl$Species)] <- "s_"
# 
# ft_w_taxa <- merge(taxa_tbl, ft_bl, by = 1)
# ft_glom <- list()
# for (tt in c("Genus", "Family", "Order", "Class", "Phylum", "Domain")){
#     ft_glom[[tt]] <- ft_w_taxa %>% group_by_at(vars("Domain":tt)) %>% summarise(across(mt_ft_bl$sample_name, sum, na.rm = T)) %>% ungroup()
# }
# ft_glom_df <- data.table::rbindlist(ft_glom, use.names = T, fill = T, idcol = "taxa.glom")
# #saveRDS(ft_glom_df, file = "tmp_ft_glom_df.Rds")
```

